<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Buscaminas</title>
  <style>
    table {
      border-collapse: collapse;
      margin: auto;
      margin-top: 30px;
    }
    #minesweeper td {
      width: 48px;
      height: 48px;
      background: #222;
      border: 1px solid #444;
      color: #fff;
      font-size: 1.6em;
      cursor: pointer;
      text-align: center;
      vertical-align: middle;
      user-select: none;
    }
    #minesweeper td.revealed {
      background: #666;
      cursor: default;
    }
    #minesweeper td.marked {
      background: #a00;
    }
    h2 {
      text-align: center;
      font-family: sans-serif;
    }
  </style>
</head>
<body>

<h2>Buscaminas - Encuentra las 9 minas</h2>
<table id="minesweeper"></table>

<script>
  const rows = 9;
  const cols = 9;
  const totalMines = 9;
  let minefield = [];

  const table = document.getElementById('minesweeper');

  function generateMinefield() {
    minefield = Array.from({ length: rows }, () => Array(cols).fill({ mine: false, count: 0, revealed: false, marked: false }));
    let placedMines = 0;
    while (placedMines < totalMines) {
      let r = Math.floor(Math.random() * rows);
      let c = Math.floor(Math.random() * cols);
      if (!minefield[r][c].mine) {
        minefield[r][c] = { ...minefield[r][c], mine: true };
        placedMines++;
      }
    }

    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (!minefield[r][c].mine) {
          let count = 0;
          for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
              if (
                r + i >= 0 && r + i < rows &&
                c + j >= 0 && c + j < cols &&
                minefield[r + i][c + j].mine
              ) {
                count++;
              }
            }
          }
          minefield[r][c].count = count;
        }
      }
    }
  }

  function drawBoard() {
    table.innerHTML = '';
    for (let r = 0; r < rows; r++) {
      let tr = document.createElement('tr');
      for (let c = 0; c < cols; c++) {
        let td = document.createElement('td');
        td.dataset.row = r;
        td.dataset.col = c;
        td.addEventListener('click', () => reveal(r, c));
        td.addEventListener('contextmenu', e => {
          e.preventDefault();
          mark(r, c);
        });

        // Doble toque en celulares
        let lastTap = 0;
        td.addEventListener('touchend', (e) => {
          const currentTime = new Date().getTime();
          const tapLength = currentTime - lastTap;
          if (tapLength < 300 && tapLength > 0) {
            revealAround(r, c);
            e.preventDefault();
          }
          lastTap = currentTime;
        });

        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    updateBoard();
  }

  function updateBoard() {
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        let td = table.rows[r].cells[c];
        let cell = minefield[r][c];
        td.className = '';
        if (cell.revealed) {
          td.classList.add('revealed');
          td.textContent = cell.mine ? 'ðŸ’£' : (cell.count || '');
        } else if (cell.marked) {
          td.classList.add('marked');
          td.textContent = 'ðŸš©';
        } else {
          td.textContent = '';
        }
      }
    }
  }

  function reveal(r, c) {
    if (r < 0 || c < 0 || r >= rows || c >= cols) return;
    let cell = minefield[r][c];
    if (cell.revealed || cell.marked) return;

    cell.revealed = true;

    if (cell.mine) {
      alert('Â¡Perdiste! HabÃ­a una mina.');
      generateMinefield();
      drawBoard();
      return;
    }

    if (cell.count === 0) {
      for (let i = -1; i <= 1; i++) {
        for (let j = -1; j <= 1; j++) {
          if (i !== 0 || j !== 0) reveal(r + i, c + j);
        }
      }
    }

    updateBoard();
    checkWin();
  }

  function mark(r, c) {
    let cell = minefield[r][c];
    if (!cell.revealed) {
      cell.marked = !cell.marked;
      updateBoard();
    }
  }

  function revealAround(r, c) {
    let cell = minefield[r][c];
    if (!cell.revealed || cell.count === 0) return;

    let flagCount = 0;
    for (let i = -1; i <= 1; i++) {
      for (let j = -1; j <= 1; j++) {
        let rr = r + i, cc = c + j;
        if (rr >= 0 && rr < rows && cc >= 0 && cc < cols) {
          if (minefield[rr][cc].marked) flagCount++;
        }
      }
    }

    if (flagCount === cell.count) {
      for (let i = -1; i <= 1; i++) {
        for (let j = -1; j <= 1; j++) {
          let rr = r + i, cc = c + j;
          if (
            rr >= 0 && rr < rows && cc >= 0 && cc < cols &&
            !minefield[rr][cc].revealed && !minefield[rr][cc].marked
          ) {
            reveal(rr, cc);
          }
        }
      }
    }
  }

  function checkWin() {
    let revealedCount = 0;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (minefield[r][c].revealed) revealedCount++;
      }
    }
    if (revealedCount === rows * cols - totalMines) {
      alert('Â¡Ganaste! Todas las minas fueron evitadas.');
      generateMinefield();
      drawBoard();
    }
  }

  generateMinefield();
  drawBoard();
</script>

</body>
</html>